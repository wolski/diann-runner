# Using Koina/Oktoberfest Libraries with DIA-NN Workflow

This guide shows how to use spectral libraries generated by Koina/Oktoberfest with the DIA-NN workflow, replacing Step A (library prediction).

## Overview

**Koina** is a prediction server/API that provides access to state-of-the-art MS prediction models (Prosit, AlphaPept, MS2PIP, etc.).

**Oktoberfest** is a Python library that orchestrates predictions via Koina to generate spectral libraries.

**Benefits over DIA-NN's built-in predictor:**
- Choice of prediction models (Prosit, AlphaPept, MS2PIP, Deeplc)
- Often superior accuracy, especially for:
  - Non-tryptic peptides
  - Modified peptides (PTMs)
  - Instrument-specific predictions
- GPU acceleration (when using Koina server)
- Access to latest published models

## Installation

### Oktoberfest

```bash
pip install oktoberfest-proteomics
```

Or with conda:
```bash
conda install -c bioconda oktoberfest
```

### Koina Server (Optional)

You can use:
1. **Public Koina server**: https://koina.wilhelmlab.org (free, requires API key)
2. **Local Koina server**: https://github.com/wilhelm-lab/koina (self-hosted)

## Workflow

### Step 0: Generate Library with Oktoberfest (Replaces Step A)

```bash
# Create Oktoberfest config
cat > oktoberfest_config.json <<EOF
{
  "fasta_path": "ProteoBenchFASTA_MixedSpecies_HYE.fasta",
  "output_path": "oktoberfest_library.speclib",
  "models": {
    "intensity": "Prosit_2020_intensity_HCD",
    "irt": "Prosit_2019_irt",
    "charge": "Prosit_2020_charge"
  },
  "enzyme": "trypsin",
  "missed_cleavages": 1,
  "min_length": 6,
  "max_length": 30,
  "variable_mods": {
    "M": ["Oxidation"]
  },
  "fixed_mods": {
    "C": ["Carbamidomethyl"]
  },
  "charges": [2, 3],
  "collision_energy": 30,
  "instrument": "QE"
}
EOF

# Generate library
oktoberfest --config oktoberfest_config.json
```

**Output:** `oktoberfest_library.speclib` (DIA-NN compatible format)

### Step 1: Generate Config for Steps B/C

Since you're bypassing Step A, you need to manually create a config file:

```bash
diann-workflow create-config \
  --output koina_workflow.json \
  --workunit-id WU_KOINA \
  --var-mods "35,15.994915,M" \
  --threads 12
```

### Step 2: Run Quantification with Refined Library (Step B)

```bash
diann-workflow quantification-refinement \
  --config koina_workflow.json \
  --predicted-lib oktoberfest_library.speclib \
  --raw-files sample*.mzML
```

This will:
1. Use your Koina/Oktoberfest predicted library
2. Generate refined empirical library from actual data
3. Perform quantification (2 passes automatically)

### Step 3: Final Quantification (Step C) - Optional

Only needed if you used `--no-quantify` in Step B or want to quantify different files:

```bash
diann-workflow final-quantification \
  --config out-DIANN_quantB/WU_KOINA_refined.speclib.config.json \
  --refined-lib out-DIANN_quantB/WU_KOINA_refined.parquet \
  --raw-files all_samples*.mzML
```

## Model Selection

Oktoberfest supports multiple models. Choose based on your data:

### Fragment Intensity Prediction

| Model | Best For | Notes |
|-------|----------|-------|
| `Prosit_2020_intensity_HCD` | Orbitrap HCD | Most common, well-validated |
| `Prosit_2023_intensity_timsTOF` | timsTOF | For Bruker instruments |
| `AlphaPept_ms2_generic` | Generic | Cross-instrument |
| `ms2pip_2021_HCD` | Alternative | Different architecture |

### Retention Time Prediction

| Model | Best For | Notes |
|-------|----------|-------|
| `Prosit_2019_irt` | iRT scale | Normalized RT |
| `Deeplc` | Chromatography-specific | More flexible |

### Ion Mobility Prediction

| Model | Best For | Notes |
|-------|----------|-------|
| `Prosit_2023_IM` | timsTOF | CCS prediction |

## Format Conversion

If Oktoberfest outputs a different format, convert to DIA-NN format:

```bash
# From .msp (NIST format)
diann --lib library.msp --convert

# From .tsv (TraML-like)
diann --lib library.tsv --convert

# Output will be library.speclib
```

## Comparing Predictors

To compare DIA-NN vs Koina predictions:

```bash
# Generate both libraries
# 1. DIA-NN predictor (Step A)
diann-workflow library-search \
  --fasta db.fasta \
  --workunit-id WU_DIANN

# 2. Koina predictor (Oktoberfest)
oktoberfest --config koina_config.json

# Run Step B with each library separately
diann-workflow quantification-refinement \
  --config out-DIANN_libA/WU_DIANN_predicted.speclib.config.json \
  --predicted-lib out-DIANN_libA/WU_DIANN_predicted.predicted.speclib \
  --raw-files test*.mzML

diann-workflow quantification-refinement \
  --config koina_workflow.json \
  --predicted-lib oktoberfest_library.speclib \
  --raw-files test*.mzML

# Compare results in out-DIANN_quantB/
```

## Advanced: Koina Server Setup

For high-throughput predictions, run your own Koina server:

```bash
# Clone repository
git clone https://github.com/wilhelm-lab/koina.git
cd koina

# Build and run with Docker
docker-compose up -d

# Configure Oktoberfest to use local server
export KOINA_SERVER="http://localhost:8080"
```

## Troubleshooting

### Library Format Compatibility

DIA-NN expects `.speclib` format with specific columns. If Oktoberfest output doesn't work:

```bash
# Check library format
head oktoberfest_library.speclib

# Convert if needed
diann --lib oktoberfest_library.speclib --convert
```

### Variable Modifications

Ensure Oktoberfest and DIA-NN use the same modification definitions:

```json
// Oktoberfest config
"variable_mods": {
  "M": ["Oxidation"]  // UniMod:35
}
```

```bash
# DIA-NN workflow
--var-mods "35,15.994915,M"
```

### Performance

Oktoberfest predictions can be slower than DIA-NN's built-in predictor unless:
- Using GPU-accelerated Koina server
- Caching predictions for reuse
- Using batched predictions

## References

- **Koina paper**: Nature Communications (2025) - https://www.nature.com/articles/s41467-025-64870-5
- **Prosit**: Nature Methods (2019) - https://www.nature.com/articles/s41592-019-0426-7
- **Oktoberfest**: GitHub - https://github.com/wilhelm-lab/oktoberfest
- **Koina server**: https://koina.wilhelmlab.org

## When to Use Koina/Oktoberfest

**Use Koina/Oktoberfest when:**
- ✅ You need instrument-specific predictions (timsTOF, Astral, etc.)
- ✅ Working with non-standard digestion (LysC, AspN, etc.)
- ✅ Complex PTM analysis requiring specialized models
- ✅ Benchmarking different prediction approaches
- ✅ Access to latest published prediction models

**Use DIA-NN's built-in predictor when:**
- ✅ Standard tryptic digestion
- ✅ Orbitrap HCD data
- ✅ Simplicity and speed are priorities
- ✅ Integrated workflow without external dependencies
- ✅ Already proven performance for your use case

## Example: Complete Workflow

```bash
# 1. Generate library with Oktoberfest
oktoberfest \
  --fasta uniprot_human.fasta \
  --output koina_library.speclib \
  --models Prosit_2020_intensity_HCD,Prosit_2019_irt \
  --enzyme trypsin \
  --missed-cleavages 2 \
  --variable-mods "M:Oxidation" \
  --fixed-mods "C:Carbamidomethyl"

# 2. Create workflow config
diann-workflow create-config \
  --output workflow_config.json \
  --workunit-id WU123 \
  --threads 32 \
  --var-mods "35,15.994915,M"

# 3. Run quantification with Koina library
diann-workflow quantification-refinement \
  --config workflow_config.json \
  --predicted-lib koina_library.speclib \
  --raw-files *.mzML

# 4. Results in out-DIANN_quantB/WU123_reportB.tsv
```

## Future Integration

We're considering adding direct Koina support:

```bash
# Potential future command
diann-workflow library-search \
  --fasta db.fasta \
  --workunit-id WU123 \
  --use-koina \
  --koina-model Prosit_2020_intensity_HCD

# Or alternative Step A implementation
diann-workflow koina-library-search \
  --fasta db.fasta \
  --workunit-id WU123 \
  --intensity-model Prosit_2020_intensity_HCD \
  --rt-model Deeplc
```

If you'd like to see this feature, please open an issue on GitHub!
